<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic%7CCascadia+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.jobshen.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言说完了filebeat的基础架构和相关设计后，我们就来看下filebeat是如何来实现这些功能的。这里只对几个相对来说比较重要的几个流程进行讨论。其余的设计会在之后的文章中进行阐述。几个流程为：  启动过程 harvester 监听过程（以log为例） outputs 处理流程（以kafka为例）">
<meta property="og:type" content="article">
<meta property="og:title" content="Filebeat 浅析（二）">
<meta property="og:url" content="https://blog.jobshen.com/posts/5be0aa9e.html">
<meta property="og:site_name" content="一杯咖啡的时间">
<meta property="og:description" content="前言说完了filebeat的基础架构和相关设计后，我们就来看下filebeat是如何来实现这些功能的。这里只对几个相对来说比较重要的几个流程进行讨论。其余的设计会在之后的文章中进行阐述。几个流程为：  启动过程 harvester 监听过程（以log为例） outputs 处理流程（以kafka为例）">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-17T04:24:14.000Z">
<meta property="article:modified_time" content="2022-05-14T02:09:28.959Z">
<meta property="article:author" content="Job Shen">
<meta property="article:tag" content="filebeat">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.jobshen.com/posts/5be0aa9e.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.jobshen.com/posts/5be0aa9e.html","path":"posts/5be0aa9e.html","title":"Filebeat 浅析（二）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Filebeat 浅析（二） | 一杯咖啡的时间</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XM4CDTM8RX"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-XM4CDTM8RX","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="一杯咖啡的时间" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一杯咖啡的时间</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">苦中作乐</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">启动过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%87%E9%9B%86"><span class="nav-number">2.2.</span> <span class="nav-text">采集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%84%9F%E6%85%A8"><span class="nav-number">2.2.1.</span> <span class="nav-text">感慨</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Job Shen"
      src="/images/Avatar.png">
  <p class="site-author-name" itemprop="name">Job Shen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kitdine" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kitdine" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.jobshen.com/posts/5be0aa9e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Avatar.png">
      <meta itemprop="name" content="Job Shen">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一杯咖啡的时间">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Filebeat 浅析（二） | 一杯咖啡的时间">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Filebeat 浅析（二）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-17 12:24:14" itemprop="dateCreated datePublished" datetime="2021-02-17T12:24:14+08:00">2021-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-14 10:09:28" itemprop="dateModified" datetime="2022-05-14T10:09:28+08:00">2022-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Filebeat/" itemprop="url" rel="index"><span itemprop="name">Filebeat</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="firestore-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>41 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>说完了<code>filebeat</code>的基础架构和相关设计后，我们就来看下<code>filebeat</code>是如何来实现这些功能的。这里只对几个相对来说比较重要的几个流程进行讨论。其余的设计会在之后的文章中进行阐述。几个流程为：</p>
<ul>
<li>启动过程</li>
<li>harvester 监听过程（以log为例）</li>
<li>outputs 处理流程（以kafka为例）</li>
</ul>
<span id="more"></span>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h2><p>首先当然是找到入口函数，对于<code>go</code>应用来说很简单，直接找<code>main()</code>就可以了。因此我们可以看到：<code>beats/filebeat/main.go</code>的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/elastic/beats/v7/filebeat/cmd&quot;</span></span><br><span class="line">	inputs <span class="string">&quot;github.com/elastic/beats/v7/filebeat/input/default-inputs&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// The basic model of execution:</span></span><br><span class="line"><span class="comment">// - input: finds files in paths/globs to harvest, starts harvesters</span></span><br><span class="line"><span class="comment">// - harvester: reads a file, sends events to the spooler</span></span><br><span class="line"><span class="comment">// - spooler: buffers events until ready to flush to the publisher</span></span><br><span class="line"><span class="comment">// - publisher: writes to the network, notifies registrar</span></span><br><span class="line"><span class="comment">// - registrar: records positions of files read</span></span><br><span class="line"><span class="comment">// Finally, input uses the registrar information, on restart, to</span></span><br><span class="line"><span class="comment">// determine where in each file to restart a harvester.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := cmd.Filebeat(inputs.Init).Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>ipnuts.Init</code>是用来获取该<code>filebeat</code>在之前的一些状态信息或者初始化一份状态信息，主要是用来记录目前<code>harvester</code>已监听到、采集到的<code>offset</code>相关信息。<code>cmd.Filebeat</code>用来初始化一个<code>Filebeat</code>对象。<code>cmd.root.Filebeat()</code>，加载&amp;初始化相关的配置，以及构建<code>filebeat</code>对象。下面代码里的<code>beater.New</code>方法会构建了<code>filebeat</code>对象。<code>GenRootCmdWithSettings</code>方法内会构建启动<code>filebeat</code>相关命令。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filebeat build the beat root command for executing filebeat and it&#x27;s subcommands.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Filebeat</span><span class="params">(inputs beater.PluginFactory)</span></span> *cmd.BeatsRootCmd &#123;</span><br><span class="line">	<span class="keyword">var</span> runFlags = pflag.NewFlagSet(Name, pflag.ExitOnError)</span><br><span class="line">	runFlags.AddGoFlag(flag.CommandLine.Lookup(<span class="string">&quot;once&quot;</span>))</span><br><span class="line">	runFlags.AddGoFlag(flag.CommandLine.Lookup(<span class="string">&quot;modules&quot;</span>))</span><br><span class="line">	settings := instance.Settings&#123;</span><br><span class="line">		RunFlags:      runFlags,</span><br><span class="line">		Name:          Name,</span><br><span class="line">		HasDashboards: <span class="literal">true</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主要是这行代码</span></span><br><span class="line">	command := cmd.GenRootCmdWithSettings(beater.New(inputs), settings)</span><br><span class="line">  </span><br><span class="line">	command.PersistentFlags().AddGoFlag(flag.CommandLine.Lookup(<span class="string">&quot;M&quot;</span>))</span><br><span class="line">	command.TestCmd.Flags().AddGoFlag(flag.CommandLine.Lookup(<span class="string">&quot;modules&quot;</span>))</span><br><span class="line">	command.SetupCmd.Flags().AddGoFlag(flag.CommandLine.Lookup(<span class="string">&quot;modules&quot;</span>))</span><br><span class="line">	command.AddCommand(cmd.GenModulesCmd(Name, <span class="string">&quot;&quot;</span>, buildModulesManager))</span><br><span class="line">	command.AddCommand(genGenerateCmd())</span><br><span class="line">	<span class="keyword">return</span> command</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GenRootCmdWithSettings</code>函数在<code>filebeat/libbeat/cmd/root.go</code>文件内。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenRootCmdWithSettings</span><span class="params">(beatCreator beat.Creator, settings instance.Settings)</span></span> *BeatsRootCmd &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">	rootCmd.RunCmd = genRunCmd(settings, beatCreator)</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">return</span> rootCmd</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此函数内会调用<code>filebeat/libbeat/cmd/run.go</code>文件内的<code>func genRunCmd(settings instance.Settings, beatCreator beat.Creator) *cobra.Command</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genRunCmd</span><span class="params">(settings instance.Settings, beatCreator beat.Creator)</span></span> *cobra.Command &#123;</span><br><span class="line">	name := settings.Name</span><br><span class="line">	runCmd := cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;run&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;Run &quot;</span> + name,</span><br><span class="line">		Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">			err := instance.Run(settings, beatCreator)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				os.Exit(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据方法名字就能关注到重点</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">instance.Run(settings, beatCreator)</span><br></pre></td></tr></table></figure>

<p><code>Run</code>方法内会构建<code>Beat</code>对象，并调用<code>launch</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run initializes and runs a Beater implementation. name is the name of the</span></span><br><span class="line"><span class="comment">// Beat (e.g. packetbeat or metricbeat). version is version number of the Beater</span></span><br><span class="line"><span class="comment">// implementation. bt is the `Creator` callback for creating a new beater</span></span><br><span class="line"><span class="comment">// instance.</span></span><br><span class="line"><span class="comment">// XXX Move this as a *Beat method?</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(settings Settings, bt beat.Creator)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> handleError(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    b, err := NewBeat(name, idxPrefix, version)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> b.launch(settings, bt)</span><br><span class="line">  &#125;())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>launch</code>方法内又构建了<code>Beater</code>对象(<code>Beater</code>是个接口)，并且在最后调用了<code>Beater</code>接口的<code>Run</code>方法启动。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Beat)</span></span> launch(settings Settings, bt beat.Creator) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	beater, err := b.createBeater(bt)</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> beater.Run(&amp;b.Beat)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口有多个实现，但是我们这里只需要关注一个，文件<code>filebeat/beater/filebeat.go</code>文件内的<code>Run</code>方法，这里就是启动<code>filebeat</code>的实现。</p>
<p>在<code>Run</code>方法内，会构建一个<code>crawler</code>对象，此对象用来采集数据，工作原理其实是对<code>Inputs</code>的包装，<code>Inputs</code>就是<code>filebeat</code>官网介绍的核心组件之一。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run allows the beater to be run as a beat.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fb *Filebeat)</span></span> Run(b *beat.Beat) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	config := fb.config</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !fb.moduleRegistry.Empty() &#123;</span><br><span class="line">		err = fb.loadModulesPipelines(b)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建相关统计信息的chan</span></span><br><span class="line">	waitFinished := newSignalWait()</span><br><span class="line">	waitEvents := newSignalWait()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// count active events for waiting on shutdown</span></span><br><span class="line">	wgEvents := &amp;eventCounter&#123;</span><br><span class="line">		count: monitoring.NewInt(<span class="literal">nil</span>, <span class="string">&quot;filebeat.events.active&quot;</span>),</span><br><span class="line">		added: monitoring.NewUint(<span class="literal">nil</span>, <span class="string">&quot;filebeat.events.added&quot;</span>),</span><br><span class="line">		done:  monitoring.NewUint(<span class="literal">nil</span>, <span class="string">&quot;filebeat.events.done&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	finishedLogger := newFinishedLogger(wgEvents)</span><br><span class="line"></span><br><span class="line">	registryMigrator := registrar.NewMigrator(config.Registry)</span><br><span class="line">	<span class="keyword">if</span> err := registryMigrator.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logp.Err(<span class="string">&quot;Failed to migrate registry file: %+v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// input 对于file的 相关进度信息，offset等</span></span><br><span class="line">	stateStore, err := openStateStore(b.Info, logp.NewLogger(<span class="string">&quot;filebeat&quot;</span>), config.Registry)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logp.Err(<span class="string">&quot;Failed to open state store: %+v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> stateStore.Close()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建一个register 用以保存相关数据</span></span><br><span class="line">	<span class="comment">// Setup registrar to persist state</span></span><br><span class="line">	registrar, err := registrar.New(stateStore, finishedLogger, config.Registry.FlushTimeout)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logp.Err(<span class="string">&quot;Could not init registrar: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure all events that were published in</span></span><br><span class="line">	registrarChannel := newRegistrarLogger(registrar)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建相关pipeline，internal queu，将上下游形成一个闭环</span></span><br><span class="line">  <span class="comment">// input --&gt; harvester --&gt; event --&gt; processors --&gt; queue --&gt; publisher --&gt; outputs</span></span><br><span class="line">	<span class="comment">// setup event counting for startup and a global common ACKer, such that all events will be</span></span><br><span class="line">	<span class="comment">// routed to the reigstrar after they&#x27;ve been ACKed.</span></span><br><span class="line">	<span class="comment">// Events with Private==nil or the type of private != file.State are directly</span></span><br><span class="line">	<span class="comment">// forwarded to `finishedLogger`. Events from the `logs` input will first be forwarded</span></span><br><span class="line">	<span class="comment">// to the registrar via `registrarChannel`, which finally forwards the events to finishedLogger as well.</span></span><br><span class="line">	<span class="comment">// The finishedLogger decrements the counters in wgEvents after all events have been securely processed</span></span><br><span class="line">	<span class="comment">// by the registry.</span></span><br><span class="line">	fb.pipeline = withPipelineEventCounter(b.Publisher, wgEvents)</span><br><span class="line">	fb.pipeline = pipetool.WithACKer(fb.pipeline, eventACKer(finishedLogger, registrarChannel))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Filebeat by default required infinite retry. Let&#x27;s configure this for all</span></span><br><span class="line">	<span class="comment">// inputs by default.  Inputs (and InputController) can overwrite the sending</span></span><br><span class="line">	<span class="comment">// guarantees explicitly when connecting with the pipeline.</span></span><br><span class="line">	fb.pipeline = pipetool.WithDefaultGuarantees(fb.pipeline, beat.GuaranteedSend)</span><br><span class="line"></span><br><span class="line">	outDone := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;) <span class="comment">// outDone closes down all active pipeline connections</span></span><br><span class="line">	pipelineConnector := channel.NewOutletFactory(outDone).Create</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a ES connection factory for dynamic modules pipeline loading</span></span><br><span class="line">	<span class="keyword">var</span> pipelineLoaderFactory fileset.PipelineLoaderFactory</span><br><span class="line">	<span class="keyword">if</span> b.Config.Output.Name() == <span class="string">&quot;elasticsearch&quot;</span> &#123;</span><br><span class="line">		pipelineLoaderFactory = newPipelineLoaderFactory(b.Config.Output.Config())</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		logp.Warn(pipelinesWarning)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	inputsLogger := logp.NewLogger(<span class="string">&quot;input&quot;</span>)</span><br><span class="line">	v2Inputs := fb.pluginFactory(b.Info, inputsLogger, stateStore)</span><br><span class="line">	v2InputLoader, err := v2.NewLoader(inputsLogger, v2Inputs, <span class="string">&quot;type&quot;</span>, cfg.DefaultType)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err) <span class="comment">// loader detected invalid state.</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> inputTaskGroup unison.TaskGroup</span><br><span class="line">	<span class="keyword">defer</span> inputTaskGroup.Stop()</span><br><span class="line">	<span class="keyword">if</span> err := v2InputLoader.Init(&amp;inputTaskGroup, v2.ModeRun); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logp.Err(<span class="string">&quot;Failed to initialize the input managers: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	inputLoader := channel.RunnerFactoryWithCommonInputSettings(b.Info, compat.Combine(</span><br><span class="line">		compat.RunnerFactory(inputsLogger, b.Info, v2InputLoader),</span><br><span class="line">		input.NewRunnerFactory(pipelineConnector, registrar, fb.done),</span><br><span class="line">	))</span><br><span class="line">	moduleLoader := fileset.NewFactory(inputLoader, b.Info, pipelineLoaderFactory, config.OverwritePipelines)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// input 相关</span></span><br><span class="line">	crawler, err := newCrawler(inputLoader, moduleLoader, config.Inputs, fb.done, *once)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logp.Err(<span class="string">&quot;Could not init crawler: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The order of starting and stopping is important. Stopping is inverted to the starting order.</span></span><br><span class="line">	<span class="comment">// The current order is: registrar, publisher, spooler, crawler</span></span><br><span class="line">	<span class="comment">// That means, crawler is stopped first.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start the registrar</span></span><br><span class="line">	err = registrar.Start()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Could not start registrar: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stopping registrar will write last state</span></span><br><span class="line">	<span class="keyword">defer</span> registrar.Stop()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stopping publisher (might potentially drop items)</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// Closes first the registrar logger to make sure not more events arrive at the registrar</span></span><br><span class="line">		<span class="comment">// registrarChannel must be closed first to potentially unblock (pretty unlikely) the publisher</span></span><br><span class="line">		registrarChannel.Close()</span><br><span class="line">		<span class="built_in">close</span>(outDone) <span class="comment">// finally close all active connections to publisher pipeline</span></span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for all events to be processed or timeout</span></span><br><span class="line">	<span class="keyword">defer</span> waitEvents.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.OverwritePipelines &#123;</span><br><span class="line">		logp.Debug(<span class="string">&quot;modules&quot;</span>, <span class="string">&quot;Existing Ingest pipelines will be updated&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = crawler.Start(fb.pipeline, config.ConfigInput, config.ConfigModules)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		crawler.Stop()</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Failed to start crawler: %+v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If run once, add crawler completion check as alternative to done signal</span></span><br><span class="line">	<span class="keyword">if</span> *once &#123;</span><br><span class="line">		runOnce := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			logp.Info(<span class="string">&quot;Running filebeat once. Waiting for completion ...&quot;</span>)</span><br><span class="line">			crawler.WaitForCompletion()</span><br><span class="line">			logp.Info(<span class="string">&quot;All data collection completed. Shutting down.&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		waitFinished.Add(runOnce)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register reloadable list of inputs and modules</span></span><br><span class="line">	inputs := cfgfile.NewRunnerList(management.DebugK, inputLoader, fb.pipeline)</span><br><span class="line">	reload.Register.MustRegisterList(<span class="string">&quot;filebeat.inputs&quot;</span>, inputs)</span><br><span class="line">	<span class="comment">// modules 载入</span></span><br><span class="line">	modules := cfgfile.NewRunnerList(management.DebugK, moduleLoader, fb.pipeline)</span><br><span class="line">	reload.Register.MustRegisterList(<span class="string">&quot;filebeat.modules&quot;</span>, modules)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> adiscover *autodiscover.Autodiscover</span><br><span class="line">	<span class="keyword">if</span> fb.config.Autodiscover != <span class="literal">nil</span> &#123;</span><br><span class="line">		adiscover, err = autodiscover.NewAutodiscover(</span><br><span class="line">			<span class="string">&quot;filebeat&quot;</span>,</span><br><span class="line">			fb.pipeline,</span><br><span class="line">			cfgfile.MultiplexedRunnerFactory(</span><br><span class="line">				cfgfile.MatchHasField(<span class="string">&quot;module&quot;</span>, moduleLoader),</span><br><span class="line">				cfgfile.MatchDefault(inputLoader),</span><br><span class="line">			),</span><br><span class="line">			autodiscover.QueryConfig(),</span><br><span class="line">			config.Autodiscover,</span><br><span class="line">			b.Keystore,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	adiscover.Start()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add done channel to wait for shutdown signal</span></span><br><span class="line">	waitFinished.AddChan(fb.done)</span><br><span class="line">	waitFinished.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stop reloadable lists, autodiscover -&gt; Stop crawler -&gt; stop inputs -&gt; stop harvesters</span></span><br><span class="line">	<span class="comment">// Note: waiting for crawlers to stop here in order to install wgEvents.Wait</span></span><br><span class="line">	<span class="comment">//       after all events have been enqueued for publishing. Otherwise wgEvents.Wait</span></span><br><span class="line">	<span class="comment">//       or publisher might panic due to concurrent updates.</span></span><br><span class="line">	inputs.Stop()</span><br><span class="line">	modules.Stop()</span><br><span class="line">	adiscover.Stop()</span><br><span class="line">	crawler.Stop()</span><br><span class="line"></span><br><span class="line">	timeout := fb.config.ShutdownTimeout</span><br><span class="line">	<span class="comment">// Checks if on shutdown it should wait for all events to be published</span></span><br><span class="line">	waitPublished := fb.config.ShutdownTimeout &gt; <span class="number">0</span> || *once</span><br><span class="line">	<span class="keyword">if</span> waitPublished &#123;</span><br><span class="line">		<span class="comment">// Wait for registrar to finish writing registry</span></span><br><span class="line">		waitEvents.Add(withLog(wgEvents.Wait,</span><br><span class="line">			<span class="string">&quot;Continue shutdown: All enqueued events being published.&quot;</span>))</span><br><span class="line">		<span class="comment">// Wait for either timeout or all events having been ACKed by outputs.</span></span><br><span class="line">		<span class="keyword">if</span> fb.config.ShutdownTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">			logp.Info(<span class="string">&quot;Shutdown output timer started. Waiting for max %v.&quot;</span>, timeout)</span><br><span class="line">			waitEvents.Add(withLog(waitDuration(timeout),</span><br><span class="line">				<span class="string">&quot;Continue shutdown: Time out waiting for events being published.&quot;</span>))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			waitEvents.AddChan(fb.done)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此整个<code>filebeat</code>启动流程基本清晰了。</p>
<h2 id="采集"><a href="#采集" class="headerlink" title="采集"></a>采集</h2><p>数据采集其实就是由<code>crawler</code>来完成的，他的主要组件就是<code>harvester</code>。那我们现在就来先看<code>crawler</code>的创建过程，入口函数在<code>filebeat/beater/filebeat.go</code>文件内的<code>Run</code>方法中的<code>crawler, err := newCrawler(inputLoader, moduleLoader, config.Inputs, fb.done, *once)</code>，具体在<code>filebeat/beater/crawler.go</code>中，然后就是启动err &#x3D; crawler.Start(fb.pipeline, config.ConfigInput, config.ConfigModules)&#96;，具体看这个方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start starts the crawler with all inputs</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *crawler)</span></span> Start(</span><br><span class="line">	pipeline beat.PipelineConnector,</span><br><span class="line">	configInputs *common.Config,</span><br><span class="line">	configModules *common.Config,</span><br><span class="line">) <span class="type">error</span> &#123;</span><br><span class="line">	log := c.log</span><br><span class="line"></span><br><span class="line">	log.Infof(<span class="string">&quot;Loading Inputs: %v&quot;</span>, <span class="built_in">len</span>(c.inputConfigs))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prospect the globs/paths given on the command line and launch harvesters</span></span><br><span class="line">	<span class="keyword">for</span> _, inputConfig := <span class="keyword">range</span> c.inputConfigs &#123;</span><br><span class="line">    <span class="comment">// 1、构建input对象并运行</span></span><br><span class="line">		err := c.startInput(pipeline, inputConfig)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;starting input failed: %+v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> configInputs.Enabled() &#123;</span><br><span class="line">    <span class="comment">// 构建reloader，动态监听配置文件更新，非主流程，这里不累赘</span></span><br><span class="line">		c.inputReloader = cfgfile.NewReloader(pipeline, configInputs)</span><br><span class="line">		<span class="keyword">if</span> err := c.inputReloader.Check(c.inputsFactory); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;creating input reloader failed: %+v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> configModules.Enabled() &#123;</span><br><span class="line">    <span class="comment">// 同上</span></span><br><span class="line">		c.modulesReloader = cfgfile.NewReloader(pipeline, configModules)</span><br><span class="line">		<span class="keyword">if</span> err := c.modulesReloader.Check(c.modulesFactory); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;creating module reloader failed: %+v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.inputReloader != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			c.inputReloader.Run(c.inputsFactory)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.modulesReloader != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			c.modulesReloader.Run(c.modulesFactory)</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Infof(<span class="string">&quot;Loading and starting Inputs completed. Enabled inputs: %v&quot;</span>, <span class="built_in">len</span>(c.inputs))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个代码主要就是启动input对象，我们继续看<code>startInput</code>这个方法，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *crawler)</span></span> startInput(</span><br><span class="line">	pipeline beat.PipelineConnector,</span><br><span class="line">	config *common.Config,</span><br><span class="line">) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !config.Enabled() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> h <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	config.Unpack(&amp;h)</span><br><span class="line">	id, err := hashstructure.Hash(h, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;can not compute id from configuration: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, ok := c.inputs[id]; ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;input with same ID already exists: %v&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	runner, err := c.inputsFactory.Create(pipeline, config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Error while initializing input: %+v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> inputRunner, ok := runner.(*input.Runner); ok &#123;</span><br><span class="line">		inputRunner.Once = c.once</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.inputs[id] = runner</span><br><span class="line"></span><br><span class="line">	c.log.Infof(<span class="string">&quot;Starting input (ID: %d)&quot;</span>, id)</span><br><span class="line">	runner.Start()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意方法最后的<code>runner.Start()</code>，就是在启动<code>input</code>。这里的<code>Runner</code>是对<code>input</code>的一个封装，用于管理<code>input</code>的生命周期，而<code>Start</code>方法就是通过<code>goroutine</code>调用其的<code>Run</code>方法，而<code>Run</code>的本质就是调用对于<code>input</code>的<code>Run</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Input <span class="keyword">interface</span> &#123;</span><br><span class="line">	Run()</span><br><span class="line">	Stop()</span><br><span class="line">	Wait()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Runner <span class="keyword">struct</span> &#123;</span><br><span class="line">	config   inputConfig</span><br><span class="line">	input    Input</span><br><span class="line">	done     <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	wg       *sync.WaitGroup</span><br><span class="line">	Once     <span class="type">bool</span></span><br><span class="line">	beatDone <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start starts the input</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Runner)</span></span> Start() &#123;</span><br><span class="line">	p.wg.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	onceWg := sync.WaitGroup&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> p.Once &#123;</span><br><span class="line">		<span class="comment">// Make sure start is only completed when Run did a complete first scan</span></span><br><span class="line">		<span class="keyword">defer</span> onceWg.Wait()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	onceWg.Add(<span class="number">1</span>)</span><br><span class="line">	inputList.Add(p.config.Type)</span><br><span class="line">	<span class="comment">// Add waitgroup to make sure input is finished</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			onceWg.Done()</span><br><span class="line">			p.stop()</span><br><span class="line">			p.wg.Done()</span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		p.Run()</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run starts scanning through all the file paths and fetch the related files. Start a harvester for each file</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Runner)</span></span> Run() &#123;</span><br><span class="line">	<span class="comment">// Initial input run</span></span><br><span class="line">	p.input.Run()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Shuts down after the first complete run of all input</span></span><br><span class="line">	<span class="keyword">if</span> p.Once &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-p.done:</span><br><span class="line">			logp.Info(<span class="string">&quot;input ticker stopped&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-time.After(p.config.ScanFrequency):</span><br><span class="line">			logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Run input&quot;</span>)</span><br><span class="line">			p.input.Run()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们最常用的就是通过<code>filebeat</code>来采集日志，我们这里就以<code>log</code>为例，来看其的具体流程，文件为<code>filebeat/input/log/input.go</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run runs the input</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Input)</span></span> Run() &#123;</span><br><span class="line">	logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Start next scan&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TailFiles is like ignore_older = 1ns and only on startup</span></span><br><span class="line">	<span class="keyword">if</span> p.config.TailFiles &#123;</span><br><span class="line">		ignoreOlder := p.config.IgnoreOlder</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Overwrite ignore_older for the first scan</span></span><br><span class="line">		p.config.IgnoreOlder = <span class="number">1</span></span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="comment">// Reset ignore_older after first run</span></span><br><span class="line">			p.config.IgnoreOlder = ignoreOlder</span><br><span class="line">			<span class="comment">// Disable tail_files after the first run</span></span><br><span class="line">			p.config.TailFiles = <span class="literal">false</span></span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 扫码，核心方法</span></span><br><span class="line">	p.scan()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// It is important that a first scan is run before cleanup to make sure all new states are read first</span></span><br><span class="line">	<span class="keyword">if</span> p.config.CleanInactive &gt; <span class="number">0</span> || p.config.CleanRemoved &#123;</span><br><span class="line">		beforeCount := p.states.Count()</span><br><span class="line">		cleanedStates, pendingClean := p.states.Cleanup()</span><br><span class="line">		logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;input states cleaned up. Before: %d, After: %d, Pending: %d&quot;</span>,</span><br><span class="line">			beforeCount, beforeCount-cleanedStates, pendingClean)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Marking removed files to be cleaned up. Cleanup happens after next scan to make sure all states are updated first</span></span><br><span class="line">	<span class="keyword">if</span> p.config.CleanRemoved &#123;</span><br><span class="line">		<span class="keyword">for</span> _, state := <span class="keyword">range</span> p.states.GetStates() &#123;</span><br><span class="line">			<span class="comment">// os.Stat will return an error in case the file does not exist</span></span><br><span class="line">			stat, err := os.Stat(state.Source)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">					p.removeState(state)</span><br><span class="line">					logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Remove state for file as file removed: %s&quot;</span>, state.Source)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					logp.Err(<span class="string">&quot;input state for %s was not removed: %s&quot;</span>, state.Source, err)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Check if existing source on disk and state are the same. Remove if not the case.</span></span><br><span class="line">				newState := file.NewState(stat, state.Source, p.config.Type, p.meta, p.fileStateIdentifier)</span><br><span class="line">				<span class="keyword">if</span> state.IdentifierName != newState.IdentifierName &#123;</span><br><span class="line">					logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;file_identity configuration for file has changed from %s to %s, generating new id&quot;</span>, state.IdentifierName, newState.IdentifierName)</span><br><span class="line">					state.Id, state.IdentifierName = p.fileStateIdentifier.GenerateID(state)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> !state.IsEqual(&amp;newState) &#123;</span><br><span class="line">					p.removeState(state)</span><br><span class="line">					logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Remove state of file as its identity has changed: %s&quot;</span>, state.Source)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>p.scan()</code>是其中的核心方法，跟踪进去看具体的实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Scan starts a scanGlob for each provided path/glob</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Input)</span></span> scan() &#123;</span><br><span class="line">	<span class="keyword">var</span> sortInfos []FileSortInfo</span><br><span class="line">	<span class="keyword">var</span> files []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">	paths := p.getFiles()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.config.ScanSort != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		sortInfos, err = getSortedFiles(p.config.ScanOrder, p.config.ScanSort, getSortInfos(paths))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logp.Err(<span class="string">&quot;Failed to sort files during scan due to error %s&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> sortInfos == <span class="literal">nil</span> &#123;</span><br><span class="line">		files = getKeys(paths)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(paths); i++ &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> path <span class="type">string</span></span><br><span class="line">		<span class="keyword">var</span> info os.FileInfo</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> sortInfos == <span class="literal">nil</span> &#123;</span><br><span class="line">			path = files[i]</span><br><span class="line">			info = paths[path]</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			path = sortInfos[i].path</span><br><span class="line">			info = sortInfos[i].info</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-p.done:</span><br><span class="line">			logp.Info(<span class="string">&quot;Scan aborted because input stopped.&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		newState, err := getFileState(path, info, p)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logp.Err(<span class="string">&quot;Skipping file %s due to error %s&quot;</span>, path, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Load last state</span></span><br><span class="line">		isNewState := p.states.IsNew(newState)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ignores all files which fall under ignore_older</span></span><br><span class="line">		<span class="keyword">if</span> p.isIgnoreOlder(newState) &#123;</span><br><span class="line">			err := p.handleIgnoreOlder(isNewState, newState)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				logp.Err(<span class="string">&quot;Updating ignore_older state error: %s&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Decides if previous state exists</span></span><br><span class="line">		<span class="keyword">if</span> isNewState &#123;</span><br><span class="line">			logp.Debug(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Start harvester for new file: %s&quot;</span>, newState.Source)</span><br><span class="line">      <span class="comment">// 发现是新文件，需构建新的harvester对象并运行</span></span><br><span class="line">			err := p.startHarvester(newState, <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">if</span> err == errHarvesterLimit &#123;</span><br><span class="line">				logp.Debug(<span class="string">&quot;input&quot;</span>, harvesterErrMsg, newState.Source, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				logp.Err(harvesterErrMsg, newState.Source, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			lastState := p.states.FindPrevious(newState)</span><br><span class="line">			p.harvestExistingFile(newState, lastState)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>scan</code>方法内首先获取所有的文件。其次获取文件状态，根据状态来判定收集最新数据，还是从历史文件收集。文件收集会构建<code>Harvester</code>对象。<code>p.startHarvester(newState, 0)</code>是其核心方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// startHarvester starts a new harvester with the given offset</span><br><span class="line">// In case the HarvesterLimit is reached, an error is returned</span><br><span class="line">func (p *Input) startHarvester(state file.State, offset int64) error &#123;</span><br><span class="line">	if p.numHarvesters.Inc() &gt; p.config.HarvesterLimit &amp;&amp; p.config.HarvesterLimit &gt; 0 &#123;</span><br><span class="line">		p.numHarvesters.Dec()</span><br><span class="line">		harvesterSkipped.Add(1)</span><br><span class="line">		return errHarvesterLimit</span><br><span class="line">	&#125;</span><br><span class="line">	// Set state to &quot;not&quot; finished to indicate that a harvester is running</span><br><span class="line">	state.Finished = false</span><br><span class="line">	state.Offset = offset</span><br><span class="line"></span><br><span class="line">	// Create harvester with state</span><br><span class="line">	// 创建harvester </span><br><span class="line">	h, err := p.createHarvester(state, func() &#123; p.numHarvesters.Dec() &#125;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		p.numHarvesters.Dec()</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"> // 对harvester 进行配置</span><br><span class="line">	err = h.Setup()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		p.numHarvesters.Dec()</span><br><span class="line">		return fmt.Errorf(&quot;error setting up harvester: %s&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Update state before staring harvester</span><br><span class="line">	// This makes sure the states is set to Finished: false</span><br><span class="line">	// This is synchronous state update as part of the scan</span><br><span class="line">	h.SendStateUpdate()</span><br><span class="line">	// 启动harvester</span><br><span class="line">	if err = p.harvesters.Start(h); err != nil &#123;</span><br><span class="line">		p.numHarvesters.Dec()</span><br><span class="line">	&#125;</span><br><span class="line">	return err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个方法的核心内容可以概括成三步：</p>
<ol>
<li><code>p.createHarvester</code>构建<code>harvester</code></li>
<li><code>p.Setup</code>配置<code>harvester</code>。<code>Setup</code>方法内会初始化文件相关的内容，以及构建文件<code>reader</code>。</li>
<li><code>p.harvesters.Start(h)</code>运行<code>harvester</code></li>
</ol>
<p>这里我们具体看下<code>p.harvesters.Start(h)</code>这个方法，其的作用就是继续在一个<code>go routine</code>中启动<code>harvester.run</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start starts the given harvester and add its to the registry</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Registry)</span></span> Start(h Harvester) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// Make sure stop is not called during starting a harvester</span></span><br><span class="line">	r.Lock()</span><br><span class="line">	<span class="keyword">defer</span> r.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure no new harvesters are started after stop was called</span></span><br><span class="line">	<span class="keyword">if</span> !r.active() &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;registry already stopped&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.wg.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add the harvester to the registry and share the lock with stop making sure Start() and Stop()</span></span><br><span class="line">	<span class="comment">// have a consistent view of the harvesters.</span></span><br><span class="line">	r.harvesters[h.ID()] = h</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			r.remove(h)</span><br><span class="line">			r.wg.Done()</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="comment">// Starts harvester and picks the right type. In case type is not set, set it to default (log)</span></span><br><span class="line">		err := h.Run()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logp.Err(<span class="string">&quot;Error running input: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>h.Run</code>其实又是一个interface方法，这里我们继续以<code>log</code>为例，因此我们这里跟踪<code>filebeat/input/log/harvester.go</code>中的<code>Run</code>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run start the harvester and reads files line by line and sends events to the defined output</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Harvester)</span></span> Run() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// Allow for some cleanup on termination</span></span><br><span class="line">	<span class="keyword">if</span> h.onTerminate != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> h.onTerminate()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outlet := channel.CloseOnSignal(h.outletFactory(), h.done)</span><br><span class="line">	forwarder := harvester.NewForwarder(outlet)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This is to make sure a harvester is not started anymore if stop was already</span></span><br><span class="line">	<span class="comment">// called before the harvester was started. The waitgroup is not incremented afterwards</span></span><br><span class="line">	<span class="comment">// as otherwise it could happened that between checking for the close channel and incrementing</span></span><br><span class="line">	<span class="comment">// the waitgroup, the harvester could be stopped.</span></span><br><span class="line">	<span class="comment">// Here stopLock is used to prevent a data race where stopWg.Add(1) below is called</span></span><br><span class="line">	<span class="comment">// while stopWg.Wait() is executing in a different goroutine, which is forbidden</span></span><br><span class="line">	<span class="comment">// according to sync.WaitGroup docs.</span></span><br><span class="line">	h.stopLock.Lock()</span><br><span class="line">	h.stopWg.Add(<span class="number">1</span>)</span><br><span class="line">	h.stopLock.Unlock()</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-h.done:</span><br><span class="line">		h.stopWg.Done()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// Channel to stop internal harvester routines</span></span><br><span class="line">		h.stop()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Makes sure file is properly closed when the harvester is stopped</span></span><br><span class="line">		h.cleanup()</span><br><span class="line"></span><br><span class="line">		harvesterRunning.Add(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Marks harvester stopping completed</span></span><br><span class="line">		h.stopWg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	harvesterStarted.Add(<span class="number">1</span>)</span><br><span class="line">	harvesterRunning.Add(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Closes reader after timeout or when done channel is closed</span></span><br><span class="line">	<span class="comment">// This routine is also responsible to properly stop the reader</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(source <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">		closeTimeout := <span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> time.Time)</span><br><span class="line">		<span class="comment">// starts close_timeout timer</span></span><br><span class="line">		<span class="keyword">if</span> h.config.CloseTimeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">			closeTimeout = time.After(h.config.CloseTimeout)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="comment">// Applies when timeout is reached</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-closeTimeout:</span><br><span class="line">			logp.Info(<span class="string">&quot;Closing harvester because close_timeout was reached: %s&quot;</span>, source)</span><br><span class="line">		<span class="comment">// Required when reader loop returns and reader finished</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-h.done:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		h.stop()</span><br><span class="line">		err := h.reader.Close()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logp.Err(<span class="string">&quot;Failed to stop harvester for file %s: %v&quot;</span>, h.state.Source, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(h.state.Source)</span><br><span class="line"></span><br><span class="line">	logp.Info(<span class="string">&quot;Harvester started for file: %s&quot;</span>, h.state.Source)</span><br><span class="line"></span><br><span class="line">	h.doneWg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		h.monitorFileSize()</span><br><span class="line">		h.doneWg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-h.done:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		message, err := h.reader.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">switch</span> err &#123;</span><br><span class="line">			<span class="keyword">case</span> ErrFileTruncate:</span><br><span class="line">				logp.Info(<span class="string">&quot;File was truncated. Begin reading file from offset 0: %s&quot;</span>, h.state.Source)</span><br><span class="line">				h.state.Offset = <span class="number">0</span></span><br><span class="line">				filesTruncated.Add(<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">case</span> ErrRemoved:</span><br><span class="line">				logp.Info(<span class="string">&quot;File was removed: %s. Closing because close_removed is enabled.&quot;</span>, h.state.Source)</span><br><span class="line">			<span class="keyword">case</span> ErrRenamed:</span><br><span class="line">				logp.Info(<span class="string">&quot;File was renamed: %s. Closing because close_renamed is enabled.&quot;</span>, h.state.Source)</span><br><span class="line">			<span class="keyword">case</span> ErrClosed:</span><br><span class="line">				logp.Info(<span class="string">&quot;Reader was closed: %s. Closing.&quot;</span>, h.state.Source)</span><br><span class="line">			<span class="keyword">case</span> io.EOF:</span><br><span class="line">				logp.Info(<span class="string">&quot;End of file reached: %s. Closing because close_eof is enabled.&quot;</span>, h.state.Source)</span><br><span class="line">			<span class="keyword">case</span> ErrInactive:</span><br><span class="line">				logp.Info(<span class="string">&quot;File is inactive: %s. Closing because close_inactive of %v reached.&quot;</span>, h.state.Source, h.config.CloseInactive)</span><br><span class="line">			<span class="keyword">case</span> reader.ErrLineUnparsable:</span><br><span class="line">				logp.Info(<span class="string">&quot;Skipping unparsable line in file: %v&quot;</span>, h.state.Source)</span><br><span class="line">				<span class="comment">//line unparsable, go to next line</span></span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				logp.Err(<span class="string">&quot;Read line error: %v; File: %v&quot;</span>, err, h.state.Source)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Get copy of state to work on</span></span><br><span class="line">		<span class="comment">// This is important in case sending is not successful so on shutdown</span></span><br><span class="line">		<span class="comment">// the old offset is reported</span></span><br><span class="line">		state := h.getState()</span><br><span class="line">		startingOffset := state.Offset</span><br><span class="line">		state.Offset += <span class="type">int64</span>(message.Bytes)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Stop harvester in case of an error</span></span><br><span class="line">		<span class="keyword">if</span> !h.onMessage(forwarder, state, message, startingOffset) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Update state of harvester as successfully sent</span></span><br><span class="line">		h.state = state</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Update metics of harvester as event was sent</span></span><br><span class="line">		h.metrics.readOffset.Set(state.Offset)</span><br><span class="line">		h.metrics.lastPublished.Set(time.Now())</span><br><span class="line">		h.metrics.lastPublishedEventTimestamp.Set(message.Ts)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个方法主要分为这么几步：</p>
<ol>
<li>创建一个<code>forwarder</code>转发器</li>
<li>死循环从<code>reader</code>里的读取内容</li>
<li>通过<code>farwarder</code>向下转发</li>
</ol>
<p><code>h.sendEvent(data, forwarder)</code>这段代码将采集的数据发送到下游，内部其实就是用<code>forwarder</code>转发了数据。</p>
<p>到此整个采集的流程就基本完成了。</p>
<h3 id="感慨"><a href="#感慨" class="headerlink" title="感慨"></a>感慨</h3><p>通过以上这些流程的分析，可以看出filebeat中其实大量使用到了<code>go routine</code>协程。而这也是<code>go</code>的最大一个特性。<code>filebeat</code>其实相当于一个大的管理器，他管理者以单个<code>input</code>文件为单位的n组协程，这样的好处就是他们之间是相互没有影响的，并且由于协程比线程要来的轻量很多，并且对于cpu的上下文切换也要少很多，对于系统资源的消耗也会小很多。那为什么有时候我们又会看到<code>filebeat</code>占用了近20%的cpu利用率，这个其实就在于<code>forwarder</code>转发后的处理流程了，如果你引入了过多的计算<code>process</code>，或者你的<code>output</code>里有重cpu的计算例如压缩，那当然会消耗更多的cpu资源，因此在使用时还是要评估好你的方案对系统资源的消耗。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Job Shen
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.jobshen.com/posts/5be0aa9e.html" title="Filebeat 浅析（二）">https://blog.jobshen.com/posts/5be0aa9e.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/filebeat/" rel="tag"># filebeat</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/6bf64646.html" rel="prev" title="Filebeat 浅析（一）">
                  <i class="fa fa-chevron-left"></i> Filebeat 浅析（一）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/9c89066f.html" rel="next" title="博客小更新记录">
                  博客小更新记录 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Job Shen</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">75k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:05</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  

  <script src="https://cdn.jsdelivr.net/npm/firebase@9.7.0/firebase-app-compat.js" integrity="sha256-kazmBornWCBvhzKX9OvlPP7/4RbDozFe7VyVx4fj/vg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.7.0/firebase-firestore-compat.js" integrity="sha256-JsvvsDGyUIHrfyMHH2FPJrbHRhjv7hOjtg1VdsuxI0s=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="firestore" type="application/json">{"enable":true,"collection":"articles","apiKey":"AIzaSyAPnpab6t0qB5X8xTX_TZFUTkSFVLNyQdw","projectId":"blog-e5d21","authDomain":"blog-e5d21.firebaseapp.com","storageBucket":"blog-e5d21.appspot.com","messagingSenderId":"737761719428","appId":"1:737761719428:web:421786d65c9bc7b7c3bed1","measurementId":"G-4SBB49HYZV"}</script>
  <script src="/js/third-party/statistics/firestore.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"kitdine","repo":"blog_git_talk","client_id":"0027cb40e78eba0adbfe","client_secret":"133ffa343a0ee4b23fef6d2ea7e36244770c2df9","admin_user":"kitdine","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"d27670da38e11faead6be62664ff3a0d"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
